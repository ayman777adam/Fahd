<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ù†Ø¸ÙˆÙ…Ø© Ø¥ÙŠØ¬Ø§Ø± ÙŠÙˆÙ…ÙŠ Ø´Ù‡Ø±ÙŠ Ù…Ø®ØªÙ„Ø· - Adora</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@500;700;800&family=Tajawal:wght@400;500;700;800&display=swap');
        
        :root {
            /* --- New Tanafos Palette --- */
            --bg-body: #f4f6f8;       /* Ø±Ù…Ø§Ø¯ÙŠ ÙØ§ØªØ­ Ø¬Ø¯Ø§Ù‹ */
            --bg-card: #ffffff;
            --text-main: #37474f;     /* Ø±Ù…Ø§Ø¯ÙŠ ØºØ§Ù…Ù‚ */
            --text-sec: #78909c;
            --border-color: #cfd8dc;
            
            --primary: #0097a7;       /* ØªØ±ÙƒÙˆØ§Ø² Ø£Ø³Ø§Ø³ÙŠ */
            --primary-light: #e0f7fa; /* Ø®Ù„ÙÙŠØ© ØªØ±ÙƒÙˆØ§Ø² ÙØ§ØªØ­Ø© */
            
            --success: #00b894;
            --danger: #d63031;
            --warning: #f1c40f;
            --booking-blue: #0288d1;  /* Ø£Ø²Ø±Ù‚ Ù…ØªÙ†Ø§Ø³Ù‚ Ù…Ø¹ Ø§Ù„ØªØ±ÙƒÙˆØ§Ø² */
            
            --shadow: 0 4px 15px rgba(0, 151, 167, 0.08); /* Ø¸Ù„ Ù…Ù„ÙˆÙ† Ø®ÙÙŠÙ */
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-body);
            /* Ù†Ù‚Ø´ Ù†Ù‚Ø§Ø· Ø®ÙÙŠÙ ÙˆÙ†Ø¸ÙŠÙ */
            background-image: radial-gradient(#b0bec5 1px, transparent 1px);
            background-size: 20px 20px;
            
            margin: 0; padding: 15px 15px 180px 15px;
            color: var(--text-main);
            transition: background-color 0.3s;
            -webkit-tap-highlight-color: transparent;
        }

        /* Zen Mode */
        body.zen-active .dashboard, 
        body.zen-active .header-glass, 
        body.zen-active .history-box {
            opacity: 0.1; filter: blur(2px); transition: 0.3s;
        }

        .container { max-width: 600px; margin: 0 auto; }

        /* --- Header Glass (Clean Style) --- */
        .header-glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid #fff;
            border-radius: 20px; padding: 15px; margin-bottom: 20px;
            text-align: center; box-shadow: var(--shadow);
        }
        .header-glass h1 { margin: 0; font-size: 1.2rem; color: var(--primary); font-weight: 800; }

        /* --- Dashboard Charts --- */
        .dashboard { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 20px; }
        .card { 
            background: var(--bg-card); border-radius: 16px; padding: 10px; 
            position: relative; box-shadow: var(--shadow); border: 1px solid var(--border-color);
            display: flex; flex-direction: column; align-items: center;
            border-bottom: 3px solid transparent; transition: 0.2s;
        }
        
        .chart-container { position: relative; width: 55px; height: 55px; margin-bottom: 5px; }
        .circular-chart { display: block; margin: 0 auto; max-width: 100%; max-height: 250px; }
        .circle-bg { fill: none; stroke: #eceff1; stroke-width: 3.8; }
        .circle { fill: none; stroke-width: 2.8; stroke-linecap: round; transition: stroke-dasharray 0.6s ease; }
        .percentage { fill: var(--text-main); font-family: 'Tajawal'; font-weight: bold; font-size: 0.6em; text-anchor: middle; }
        
        .card h3 { margin: 0; font-size: 0.7rem; color: var(--text-sec); text-align: center; font-weight: 700; }
        .card-detail { font-size: 0.6rem; color: #90a4ae; margin-top: 2px; }

        /* Soft Colors for Charts */
        .c-single .circle { stroke: #26c6da; }
        .c-1bhk .circle { stroke: #ffca28; }
        .c-2bhk .circle { stroke: #7e57c2; }

        /* --- Steppers (Clean Tanafos Style) --- */
        .stepper-box {
            background: #fff; padding: 15px; border-radius: 15px; margin-top: 15px;
            border: 1px solid var(--border-color); box-shadow: var(--shadow);
        }
        .stepper-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .stepper-item { text-align: center; }
        
        .stepper-label { 
            font-size: 0.8rem; margin-bottom: 8px; font-weight: 800; display: block; 
            border-bottom: 2px solid transparent; display: inline-block; padding-bottom: 2px;
        }
        
        .stepper-ctrl {
            display: flex; align-items: center; justify-content: space-between;
            background: var(--bg-body); border-radius: 10px; padding: 2px;
            border: 1px solid var(--border-color);
        }
        .s-btn {
            width: 30px; height: 30px; border: none; border-radius: 8px;
            background: #fff; cursor: pointer; font-weight: bold; font-size: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); color: var(--text-main);
        }
        .s-btn:active { transform: scale(0.9); }
        .s-minus { color: var(--danger); } .s-plus { color: var(--success); }
        .s-val { font-weight: 800; font-size: 1rem; width: 25px; color: var(--primary); }
        
        .lbl-desc { font-size: 0.65rem; font-weight: bold; margin-top: 4px; display: block; }
        .lbl-vac { color: var(--success); }
        .lbl-book { color: var(--booking-blue); }

        .hidden-logic-input { display: none; }

        /* --- Sticky Footer --- */
        .sticky-footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border-top: 1px solid var(--border-color);
            padding: 15px 15px 10px 15px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
            z-index: 9999;
            display: flex; flex-direction: column; gap: 8px;
            box-sizing: border-box; border-radius: 20px 20px 0 0;
        }
        .advice-row { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 5px; }
        .advice-pill {
            flex: 1; min-width: 80px; padding: 8px; border-radius: 10px; text-align: center;
            font-weight: 800; font-size: 0.7rem; display: flex; align-items: center; justify-content: center;
            white-space: nowrap;
        }
        /* Soft Pastel Pills */
        .pill-green { background: #e0f2f1; color: #00695c; border: 1px solid #80cbc4; }
        .pill-red { background: #ffebee; color: #c62828; border: 1px solid #ef9a9a; }
        
        .footer-actions { display: flex; gap: 10px; }
        .btn-whatsapp {
            flex: 1; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 10px;
            font-size: 14px; font-weight: bold; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px;
            box-shadow: 0 4px 15px rgba(0, 151, 167, 0.25);
        }
        .dev-credit { text-align: center; font-size: 0.65rem; color: #90a4ae; margin-top: 5px; }

        /* --- Forms & Inputs --- */
        .form-box { background: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: var(--shadow); border: 1px solid var(--border-color); }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .full-width { grid-column: span 3; }
        input, select {
            width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;
            font-size: 14px; background: #fff; box-sizing: border-box; font-family: 'Tajawal'; color: var(--text-main);
        }
        input:focus, select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px var(--primary-light); }
        
        /* --- Action Buttons --- */
        .action-buttons { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 20px; }
        .btn-action {
            border: none; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer;
            color: white; font-size: 11px; display: flex; flex-direction: column; align-items: center;
            background: #546e7a; /* Default Slate Blue */
        }
        .btn-close { background: #0277bd; } .btn-print { background: #f9a825; } .btn-excel { background: #2e7d32; }
        
        /* --- Finance Cards --- */
        .finance-section { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .finance-card {
            background: white; padding: 12px; border-radius: 10px; text-align: center;
            border-top: 3px solid var(--primary); box-shadow: var(--shadow);
        }
        .finance-val { font-size: 22px; font-weight: 800; color: var(--text-main); }
        
        /* --- History Table --- */
        .history-box { background: white; padding: 10px; border-radius: 12px; overflow: hidden; box-shadow: var(--shadow); margin-bottom: 20px; border: 1px solid var(--border-color); }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { background: var(--primary-light); padding: 8px 2px; color: var(--primary); font-size: 10px; text-align: center; border-bottom: 2px solid var(--border-color); }
        td { padding: 8px 2px; border-bottom: 1px solid #eee; text-align: center; font-size: 11px; vertical-align: middle; word-wrap: break-word; color: var(--text-main); }
        
        .status-new { color: var(--danger); } .status-pending { color: var(--warning); } .status-done { color: var(--success); }
        .confirmed-transfer.pending-transfer { color: var(--success); cursor: pointer; text-decoration: underline; font-weight: bold; }
        .pending-transfer { color: var(--danger); cursor: pointer; text-decoration: underline; font-weight: bold; }
        .confirmed-transfer { color: var(--success); font-weight: bold; }
        tr.handed-over { background-color: #f5f5f5; opacity: 0.6; } tr.pending-approval { background-color: #fff8e1; }
        .btn-out { background: var(--danger); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px; }

        /* Loader & Toast */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.98); z-index: 99999; display: flex; justify-content: center; align-items: center; flex-direction: column; color: var(--primary); }
        .glass-toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(38, 50, 56, 0.9); color: white; padding: 15px 25px; border-radius: 20px; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 10000; text-align: center; }
        .admin-btn { width: 100%; padding: 12px; margin-bottom: 10px; border:none; border-radius:8px; color:white; font-weight:bold; cursor:pointer; }
        
        @media print {
            body * { visibility: hidden; }
            .history-box, .history-box * { visibility: visible; }
            .history-box { position: absolute; left: 0; top: 0; width: 100%; box-shadow: none; border:none; }
            .sticky-footer, .header-glass, .action-buttons, .dashboard, .form-box { display: none !important; }
        }
    </style>
</head>
<body>

<div id="loader">
    <div style="font-size:30px;">â³</div>
    <div id="loaderText">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…...</div>
</div>

<div id="toast-container">
    <div class="glass-toast" id="toastMsg">
        <span id="toastIcon">âœ…</span> <span id="toastText">ØªÙ…</span>
    </div>
</div>

<div class="container">
    
    <div class="header-glass">
        <h1>ğŸ¢  Adora - Ù…Ù†Ø¸ÙˆÙ…Ø© Ø¥ÙŠØ¬Ø§Ø± ÙŠÙˆÙ…ÙŠ Ø´Ù‡Ø±ÙŠ Ù…Ø®ØªÙ„Ø·</h1>
    </div>

    <div class="finance-section">
        <div class="finance-card">
            <div class="finance-val"><span id="totalCash">0</span></div>
            <h4>Ù†Ù‚Ø¯Ù‰ (Ø§Ù„ÙƒØ§Ø´)</h4>
        </div>
        <div class="finance-card" style="border-top-color: #5e35b1;">
            <div class="finance-val" style="color: #5e35b1;"><span id="totalNet">0</span></div>
            <h4>Ø´Ø¨ÙƒØ© / ØªØ­ÙˆÙŠÙ„</h4>
        </div>
    </div>

    <div class="action-buttons">
        <button class="btn-action btn-close" onclick="requestHandover()">âœ‹ Ø·Ù„Ø¨ ØªÙˆØ±ÙŠØ¯</button>
        <button class="btn-action btn-print" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        <button class="btn-action btn-excel" onclick="exportToExcel()">ğŸ“Š ØªØµØ¯ÙŠØ± Excel</button>
    </div>
    <button id="adminBtn" class="admin-btn" style="display:none;"></button>

    <div id="checkoutAlert" style="display:none; background:#ffebee; color:#c62828; padding:10px; text-align:center; border-radius:8px; margin-bottom:15px; font-weight:bold; border:1px solid #ef9a9a;"></div>

    <div class="dashboard">
        <div class="card c-single" id="card-single">
            <div class="chart-container">
                <svg viewBox="0 0 36 36" class="circular-chart">
                    <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    <path class="circle" id="chart-single" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    <text x="18" y="20.35" class="percentage" id="count-single">0</text>
                </svg>
            </div>
            <h3>Ù…ÙØ±Ø¯</h3>
            <div class="card-detail" id="detail-single">...</div>
        </div>
        <div class="card c-1bhk" id="card-1bhk">
            <div class="chart-container">
                <svg viewBox="0 0 36 36" class="circular-chart">
                    <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    <path class="circle" id="chart-1bhk" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    <text x="18" y="20.35" class="percentage" id="count-1bhk">0</text>
                </svg>
            </div>
            <h3>ØºØ±ÙØ© ÙˆØµØ§Ù„Ø©</h3>
            <div class="card-detail" id="detail-1bhk">...</div>
        </div>
        <div class="card c-2bhk" id="card-2bhk">
            <div class="chart-container">
                <svg viewBox="0 0 36 36" class="circular-chart">
                    <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    <path class="circle" id="chart-2bhk" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    <text x="18" y="20.35" class="percentage" id="count-2bhk">0</text>
                </svg>
            </div>
            <h3>ØºØ±ÙØªÙŠÙ†</h3>
            <div class="card-detail" id="detail-2bhk">...</div>
        </div>
    </div>

    <div class="form-box">
        <div style="font-weight:bold; margin-bottom:10px; border-bottom:1px solid var(--border-color); padding-bottom:5px; color:var(--primary)">ØªØ³Ø¬ÙŠÙ„ Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯</div>
        <form id="checkinForm">
            <div class="form-grid">
                <div class="full-width"><label>Ù…ØµØ¯Ø± Ø§Ù„Ø­Ø¬Ø²</label><select id="bookingSource"><option value="Ø§Ø³ØªÙ‚Ø¨Ø§Ù„">Ø§Ø³ØªÙ‚Ø¨Ø§Ù„</option><option value="Ø¨ÙˆÙƒÙŠÙ†Ø¬">Ø¨ÙˆÙƒÙŠÙ†Ø¬</option></select></div>
                <div class="full-width"><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><select id="checkInDate" onchange="calculateCheckout()"></select></div>
                <div><label>Ø§Ù„Ù†ÙˆØ¹</label><select id="rentType" onchange="toggleRentType()"><option value="ÙŠÙˆÙ…ÙŠ">ÙŠÙˆÙ…ÙŠ</option><option value="Ø´Ù‡Ø±ÙŠ">Ø´Ù‡Ø±ÙŠ</option></select></div>
                <div><label>Ø§Ù„Ù„ÙŠØ§Ù„ÙŠ</label><input type="number" id="nightsCount" min="1" step="1" oninput="calculateDailyTotal()"></div>
                <div class="full-width"><label>Ø§Ù„Ø®Ø±ÙˆØ¬</label><input type="text" id="checkOutDate" readonly style="background:#eceff1;"></div>
                <div><label>Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©</label><input type="number" id="roomNumber" placeholder="101" step="1" oninput="updateButtonState()"></div>
                <div><label>Ù†ÙˆØ¹ Ø§Ù„ØºØ±ÙØ©</label><select id="roomTypeInput"><option value="single">Ù…ÙØ±Ø¯</option><option value="1bhk">ÙˆØµØ§Ù„Ø©</option><option value="2bhk">ØºØ±ÙØªÙŠÙ†</option></select></div>
            </div>

            <div id="dailyRateDiv" style="margin-top:10px;"><label style="color:var(--booking-blue)">Ø§Ù„Ø³Ø¹Ø± (Ø§Ù„ÙŠÙˆÙ…ÙŠ)</label><input type="number" id="dailyRate" step="0.01" oninput="calculateDailyTotal()"></div>
            <div class="form-grid" style="margin-top:10px;">
                <div class="full-width"><label>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</label><input type="number" id="totalRentAmount" step="0.01" oninput="calculateRemaining()"></div>
                <div><label>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</label><input type="number" id="paidAmount" step="0.01" oninput="calculateRemaining()"></div>
                <div><label>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</label><input type="number" id="remainingAmount" step="0.01" readonly style="background:#eceff1;"></div>
            </div>

            <div style="margin-top:10px;">
                <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
                <select id="paymentMethod" onchange="togglePaymentSections()">
                    <option value="Ù†Ù‚Ø¯Ù‰">Ù†Ù‚Ø¯Ù‰</option><option value="Ø´Ø¨ÙƒØ©">Ø´Ø¨ÙƒØ©</option>
                    <option value="Ù…Ø®ØªÙ„Ø·">Ù…Ø®ØªÙ„Ø·</option><option value="ØªØ­ÙˆÙŠÙ„">ØªØ­ÙˆÙŠÙ„</option>
                </select>
            </div>
            
            <div id="mixedSection" style="display:none; margin-top:5px;" class="form-grid">
                <input type="number" id="mixedCash" step="0.01" placeholder="ÙƒØ§Ø´" oninput="calculateMixedTotal()">
<input type="number" id="mixedNet" step="0.01" placeholder="Ø´Ø¨ÙƒØ©" oninput="calculateMixedTotal()">
<input type="number" id="mixedBank" step="0.01" placeholder="ØªØ­ÙˆÙŠÙ„" oninput="calculateMixedTotal()">
            </div>
            
            <div id="bankSection" style="display:none; margin-top:5px;">
                <select id="bankStatusSelect" onchange="toggleImageUpload()">
                    <option value="confirmed">âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</option>
                    <option value="pending">â³ Ù„Ù… ÙŠØ¤ÙƒØ¯</option>
                </select>
                <div id="bankProofSection" style="display:none; margin-top:10px; border-top: 1px dashed var(--border-color); padding-top: 10px;">
                    <label style="font-weight:bold; color:var(--primary);">ØµÙˆØ±Ø© Ø¥Ø«Ø¨Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„ (Ø¥Ù„Ø²Ø§Ù…ÙŠ):</label>
                    
                    <div style="display:flex; gap: 8px; margin-top: 5px;">
                        <button type="button" class="btn-action" style="background:#5e35b1; flex: 1;" onclick="document.getElementById('cameraInput').click()">ğŸ“¸ ÙƒØ§Ù…ÙŠØ±Ø§</button>
                        <button type="button" class="btn-action" style="background:#0288d1; flex: 1;" onclick="document.getElementById('fileInput').click()">ğŸ“ Ø±ÙØ¹ Ù…Ù„Ù (ØµÙˆØ±Ø©/PDF)</button>
                    </div>

                    <div id="fileNameDisplay" style="margin-top: 8px; font-size: 0.8rem; font-weight: bold; color: var(--success);"></div>
                    
                    <input type="file" id="cameraInput" accept="image/*" capture="camera" style="display:none;">
                    <input type="file" id="fileInput" accept="image/*, application/pdf" style="display:none;">

                    <input type="file" id="bankProofImage" style="display:none;"> 
                </div>
            </div>

            <div class="stepper-box">
                <div style="text-align:center; color:var(--text-sec); font-size:0.8rem; margin-bottom:10px;">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª (Ù„Ù…Ø³Ø© ÙˆØ§Ø­Ø¯Ø©)</div>
                
                <div class="stepper-label" style="color:#26c6da; border-bottom-color:#26c6da">ØºØ±ÙØ© Ù…ÙØ±Ø¯ (3)</div>
                <div class="stepper-grid">
                    <div class="stepper-item">
                        <div class="stepper-ctrl">
                            <button type="button" class="s-btn s-minus" onclick="stepVal('vac3Input', -1)">-</button>
                            <span class="s-val" id="disp-vac3">0</span>
                            <button type="button" class="s-btn s-plus" onclick="stepVal('vac3Input', 1)">+</button>
                        </div>
                        <span class="lbl-desc lbl-vac">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø§ØºØ± (Ø§Ù„Ù…ÙØ§ØªÙŠØ­)</span>
                    </div>
                    <div class="stepper-item">
                        <div class="stepper-ctrl" style="border-color: var(--booking-blue);">
                            <button type="button" class="s-btn s-minus" onclick="stepVal('book3Input', -1)">-</button>
                            <span class="s-val" id="disp-book3" style="color:var(--booking-blue)">0</span>
                            <button type="button" class="s-btn s-plus" onclick="stepVal('book3Input', 1)">+</button>
                        </div>
                        <span class="lbl-desc lbl-book">Ø­Ø¬ÙˆØ²Ø§Øª Ø¨ÙˆÙƒÙŠÙ†Ø¬ (Ù…Ø¤ÙƒØ¯)</span>
                    </div>
                </div>
                <hr style="border:0; border-top:1px dashed #eee; margin:8px 0;">

                <div class="stepper-label" style="color:#ffca28; border-bottom-color:#ffca28">ØºØ±ÙØ© ÙˆØµØ§Ù„Ø© (1)</div>
                <div class="stepper-grid">
                    <div class="stepper-item">
                        <div class="stepper-ctrl">
                            <button type="button" class="s-btn s-minus" onclick="stepVal('vac1Input', -1)">-</button>
                            <span class="s-val" id="disp-vac1">0</span>
                            <button type="button" class="s-btn s-plus" onclick="stepVal('vac1Input', 1)">+</button>
                        </div>
                        <span class="lbl-desc lbl-vac">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø§ØºØ± (Ø§Ù„Ù…ÙØ§ØªÙŠØ­)</span>
                    </div>
                    <div class="stepper-item">
                        <div class="stepper-ctrl">
                            <button type="button" class="s-btn s-minus" onclick="stepVal('book1Input', -1)">-</button>
                            <span class="s-val" id="disp-book1" style="color:var(--booking-blue)">0</span>
                            <button type="button" class="s-btn s-plus" onclick="stepVal('book1Input', 1)">+</button>
                        </div>
                        <span class="lbl-desc lbl-book">Ø­Ø¬ÙˆØ²Ø§Øª Ø¨ÙˆÙƒÙŠÙ†Ø¬ (Ù…Ø¤ÙƒØ¯)</span>
                    </div>
                </div>
                <hr style="border:0; border-top:1px dashed #eee; margin:8px 0;">

                <div class="stepper-label" style="color:#7e57c2; border-bottom-color:#7e57c2">ØºØ±ÙØªÙŠÙ† (2)</div>
                <div class="stepper-grid">
                    <div class="stepper-item">
                        <div class="stepper-ctrl">
                            <button type="button" class="s-btn s-minus" onclick="stepVal('vac2Input', -1)">-</button>
                            <span class="s-val" id="disp-vac2">0</span>
                            <button type="button" class="s-btn s-plus" onclick="stepVal('vac2Input', 1)">+</button>
                        </div>
                        <span class="lbl-desc lbl-vac">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø§ØºØ± (Ø§Ù„Ù…ÙØ§ØªÙŠØ­)</span>
                    </div>
                    <div class="stepper-item">
                        <div class="stepper-ctrl">
                            <button type="button" class="s-btn s-minus" onclick="stepVal('book2Input', -1)">-</button>
                            <span class="s-val" id="disp-book2" style="color:var(--booking-blue)">0</span>
                            <button type="button" class="s-btn s-plus" onclick="stepVal('book2Input', 1)">+</button>
                        </div>
                        <span class="lbl-desc lbl-book">Ø­Ø¬ÙˆØ²Ø§Øª Ø¨ÙˆÙƒÙŠÙ†Ø¬ (Ù…Ø¤ÙƒØ¯)</span>
                    </div>
                </div>

                <input type="number" id="vac1Input" class="hidden-logic-input">
                <input type="number" id="vac2Input" class="hidden-logic-input">
                <input type="number" id="vac3Input" class="hidden-logic-input">
                <input type="number" id="book1Input" class="hidden-logic-input">
                <input type="number" id="book2Input" class="hidden-logic-input">
                <input type="number" id="book3Input" class="hidden-logic-input">
            </div>
        </form>
    </div>

    <div class="history-box">
        <div style="padding:10px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
            <span style="font-weight:bold; color:var(--text-sec)">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</span>
            <div style="display:flex; gap:5px;">
                <button onclick="deleteHandedOver()" style="font-size:9px; background:#90a4ae; color:white; border:none; padding:5px; border-radius:5px;">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ±Ø¯</button>
                <button onclick="deleteExpired()" style="font-size:9px; background:#ef5350; color:white; border:none; padding:5px; border-radius:5px;">â³ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªÙ‡ÙŠ</button>
            </div>
        </div>
        <table id="historyTable">
            <thead>
                <tr>
                    <th style="width:15%">Ø§Ù„ØºØ±ÙØ©</th>
                    <th style="width:15%">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                    <th style="width:25%">Ø§Ù„Ø¯ÙØ¹</th>
                    <th style="width:20%">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th style="width:10%">ØªØ±Ø­ÙŠÙ„</th>
                    <th style="width:15%">Ø¥Ø¬Ø±Ø§Ø¡</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div class="sticky-footer">
    <div class="advice-row" id="advice-container"></div>
    <div class="footer-actions">
        <button class="btn-whatsapp" id="saveBtn" onclick="document.getElementById('checkinForm').requestSubmit()">
            Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„ ğŸš€
        </button>
    </div>
    <div class="dev-credit">ØªØ·ÙˆÙŠØ±: Ø§ÙŠÙ…Ù† Ø§Ø¨Ùˆ ÙˆØ±Ø¯Ù‡ | 77aayy@gmail.com</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, push, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js"; // ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©

    const firebaseConfig = {
      apiKey: "AIzaSyBY09i3QHvaZFmNpOUHYEIFoU_3dJvycso",
      authDomain: "hotel-system-3dd07.firebaseapp.com",
      databaseURL: "https://hotel-system-3dd07-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "hotel-system-3dd07",
      storageBucket: "hotel-system-3dd07.firebasestorage.app",
      messagingSenderId: "134497063312",
      appId: "1:134497063312:web:d8f589f291d55a85a2e315"
    };

    let app, db, storage; // ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    try {
        app = initializeApp(firebaseConfig);
        db = getDatabase(app);
        storage = getStorage(app); // ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©
    } catch(e) {
        document.getElementById('loaderText').innerHTML = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…";
    }

    let transactions = [];
    const transactionsRef = ref(db, 'transactions');
    const vacancyRef = ref(db, 'vacancies');

    // --- Stepper Logic ---
    window.stepVal = function(inputId, amount) {
        const input = document.getElementById(inputId);
        let val = parseInt(input.value) || 0;
        val += amount;
        if(val < 0) val = 0;
        input.value = val;
        window.saveVacanciesToCloud();
        if(navigator.vibrate) navigator.vibrate(15);
        const dispId = 'disp-' + inputId.replace('Input', '');
        const disp = document.getElementById(dispId);
        if(disp) { disp.innerText = val; disp.style.transform = 'scale(1.3)'; setTimeout(()=> disp.style.transform = 'scale(1)', 100); }
    }

    // --- Sync Logic ---
    onValue(vacancyRef, (snapshot) => {
        const data = snapshot.val() || { v1: 0, v2: 0, v3: 0, b1: 0, b2: 0, b3: 0 };
        const map = { 'vac1Input': data.v1, 'vac2Input': data.v2, 'vac3Input': data.v3, 'book1Input': data.b1, 'book2Input': data.b2, 'book3Input': data.b3 };
        for (const [id, val] of Object.entries(map)) {
            document.getElementById(id).value = val;
            const dispId = 'disp-' + id.replace('Input', '');
            if(document.getElementById(dispId)) document.getElementById(dispId).innerText = val;
        }
        updateTopCounters(data.v1, data.v2, data.v3, data.b1, data.b2, data.b3);
        document.getElementById('loader').style.display = 'none';
    });

    window.saveVacanciesToCloud = function() {
        const data = { v1: document.getElementById('vac1Input').value, v2: document.getElementById('vac2Input').value, v3: document.getElementById('vac3Input').value, b1: document.getElementById('book1Input').value, b2: document.getElementById('book2Input').value, b3: document.getElementById('book3Input').value };
        update(vacancyRef, data);
    }

    window.updateTopCounters = function(v1, v2, v3, b1=0, b2=0, b3=0) {
        const net1 = (parseInt(v1)||0) - (parseInt(b1)||0);
        const net2 = (parseInt(v2)||0) - (parseInt(b2)||0);
        const net3 = (parseInt(v3)||0) - (parseInt(b3)||0);

        updateChart('chart-single', 'count-single', net3, v3);
        document.getElementById('detail-single').innerText = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${v3} / Ù…Ø­Ø¬ÙˆØ² ${b3}`;
        updateChart('chart-1bhk', 'count-1bhk', net1, v1);
        document.getElementById('detail-1bhk').innerText = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${v1} / Ù…Ø­Ø¬ÙˆØ² ${b1}`;
        updateChart('chart-2bhk', 'count-2bhk', net2, v2);
        document.getElementById('detail-2bhk').innerText = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${v2} / Ù…Ø­Ø¬ÙˆØ² ${b2}`;

        updateStickyAdvice(v1, v2, v3, b1, b2, b3);
    };

    function updateChart(circleId, textId, net, total) {
        const circle = document.getElementById(circleId);
        let pct = total > 0 ? (net / total) * 100 : 0;
        if(pct < 0) pct = 0;
        circle.setAttribute('stroke-dasharray', `${pct}, 100`);
        document.getElementById(textId).innerText = net;
        if(net <= 0) circle.style.stroke = 'var(--danger)'; else circle.style.stroke = '';
    }

    function updateStickyAdvice(v1, v2, v3, b1, b2, b3) {
        const c = document.getElementById('advice-container');
        let html = '';
        
        const vac1 = parseInt(v1)||0, vac2 = parseInt(v2)||0, vac3 = parseInt(v3)||0;
        const book1 = parseInt(b1)||0, book2 = parseInt(b2)||0, book3 = parseInt(b3)||0;

        if (book3 >= vac3 && vac3 > 0) html += `<div class="advice-pill pill-red">â›” Ù‚ÙÙ„ Ù…ÙØ±Ø¯ (${book3-vac3})</div>`;
        else if (vac3 >= 5) html += `<div class="advice-pill pill-green">âœ… Ø§ÙØªØ­ Ù…ÙØ±Ø¯ (${vac3-book3})</div>`;

        if (book1 >= vac1 && vac1 > 0) html += `<div class="advice-pill pill-red">â›” Ù‚ÙÙ„ ÙˆØµØ§Ù„Ø© (${book1-vac1})</div>`;
        else if (vac1 >= 5) html += `<div class="advice-pill pill-green">âœ… Ø§ÙØªØ­ ÙˆØµØ§Ù„Ø© (${vac1-book1})</div>`;

        if (book2 >= vac2 && vac2 > 0) html += `<div class="advice-pill pill-red">â›” Ù‚ÙÙ„ ØºØ±ÙØªÙŠÙ† (${book2-vac2})</div>`;
        else if (vac2 >= 5) html += `<div class="advice-pill pill-green">âœ… Ø§ÙØªØ­ ØºØ±ÙØªÙŠÙ† (${vac2-book2})</div>`;

        c.innerHTML = html;
    }

    // --- Transactions & History (Preserved Logic) ---
    onValue(transactionsRef, (snapshot) => {
        const data = snapshot.val();
        transactions = [];
        if (data) {
            Object.keys(data).forEach(key => { transactions.push({ ...data[key], firebaseKey: key }); });
            transactions.sort((a, b) => b.id - a.id);
        }
        setupLazyLoading();
        updateStatistics();
    });

    window.setupLazyLoading = function() {
        let currentIndex = 0;
        const batchSize = 20;
        function loadNextBatch() {
            const batch = transactions.slice(currentIndex, currentIndex + batchSize);
            currentIndex += batchSize;
            window.updateUIBatch(batch);
            if (currentIndex < transactions.length) setTimeout(loadNextBatch, 50); 
        }
        document.querySelector('#historyTable tbody').innerHTML = '';
        loadNextBatch();
    }

    window.updateUIBatch = function(batch) {
        const tbody = document.querySelector('#historyTable tbody');
        batch.forEach(t => {
            if(!t.roomNumber) return;
            const row = document.createElement('tr');
            
            let statusText = '';
            if (t.isHandedOver === true) { row.classList.add('handed-over'); statusText = '<span class="status-done">ØªÙ… Ø§Ù„ØªÙˆØ±ÙŠØ¯</span>'; }
            else if (t.isHandedOver === 'pending') { row.classList.add('pending-approval'); statusText = '<span class="status-pending">â³ Ø§Ù†ØªØ¸Ø§Ø±</span>'; }
            else { statusText = '<span class="status-new">ğŸ†• Ø¬Ø¯ÙŠØ¯</span>'; }

            let paymentDisplay = t.paymentMethod;
            // ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù„ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© "ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…" Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø©
            if (t.paymentMethod.includes('Ù„Ù… ÙŠØ¤ÙƒØ¯')) paymentDisplay = `<span class="pending-transfer" onclick="toggleBankStatus('${t.firebaseKey}', '${t.paymentMethod}')">${t.paymentMethod}</span>`;
            else if (t.paymentMethod.includes('ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…')) paymentDisplay = `<span class="confirmed-transfer" ${t.proofUrl ? `onclick="window.open('${t.proofUrl}', '_blank')"` : ''}>${t.paymentMethod}</span>`;


            const dateObj = new Date(t.checkIn);
            let dateDisplay = t.checkIn;
            if(!isNaN(dateObj)) {
                const dayName = dateObj.toLocaleDateString('ar-EG', { weekday: 'long' });
                const datePart = dateObj.toLocaleDateString('en-GB');
                dateDisplay = `${datePart} ${dayName}`;
            }

            let btn = t.status === 'active' ? `<button class="btn-out" onclick="checkoutRoom('${t.firebaseKey}')">Ø®Ø±ÙˆØ¬</button>` : 'âœ”';

            row.innerHTML = `
                <td><b>${t.roomNumber}</b><br><span style="font-size:9px;color:#90a4ae">${t.roomTypeName}</span></td>
                <td style="color:${t.isHandedOver===true?'inherit':'var(--primary)'};font-weight:bold">${t.amount}</td>
                <td style="font-size:10px">${paymentDisplay}</td>
                <td style="font-size:9px;color:#666">${dateDisplay}<br>${t.checkOut}</td>
                <td style="font-size:10px;font-weight:bold">${statusText}</td>
                <td>${btn}</td>
            `;
            tbody.appendChild(row);
        });
    }

    window.updateStatistics = function() {
        let cash=0, net=0, checkoutCount=0;
        const todayStr = new Date().toLocaleDateString('en-GB');
        let hasNew=false, hasPending=false;

        transactions.forEach(t => {
            if(!t.roomNumber) return;
            if (t.isHandedOver === false) hasNew = true;
            if (t.isHandedOver === 'pending') hasPending = true;
            if(t.isHandedOver !== true) {
                const amt = parseFloat(t.amount||0);
                if(t.mixDetails) { cash+=parseFloat(t.mixDetails.cash||0); net+=parseFloat(t.mixDetails.net||0)+parseFloat(t.mixDetails.bank||0); }
                else { if(t.paymentMethod.includes('Ù†Ù‚Ø¯Ù‰')) cash+=amt; else net+=amt; }
            }
            if (t.status === 'active' && t.checkOut === todayStr) checkoutCount++;
        });
        
        document.getElementById('totalCash').innerText = cash;
        document.getElementById('totalNet').innerText = net;
        
        const btn = document.getElementById('adminBtn');
        btn.style.display = 'block';
        if(hasPending) { btn.innerText='â³ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„ØªÙˆØ±ÙŠØ¯'; btn.style.background='var(--warning)'; btn.onclick=approveHandover; }
        else if(hasNew) { btn.innerText='âš ï¸ ÙŠÙˆØ¬Ø¯ Ù…Ø¨Ø§Ù„Øº'; btn.style.background='var(--danger)'; btn.onclick=null; }
        else { btn.innerText='âœ… Ø§Ù„Ø¹Ù‡Ø¯Ø© Ù†Ø¸ÙŠÙØ©'; btn.style.background='#eceff1'; btn.style.color='#90a4ae'; }

        const alertBox = document.getElementById('checkoutAlert');
        if (checkoutCount > 0) { alertBox.style.display = 'block'; alertBox.innerText = `âš ï¸ Ø§Ù„ÙŠÙˆÙ… ÙŠÙˆØ¬Ø¯ (${checkoutCount}) Ø­Ø§Ù„Ø§Øª Ø®Ø±ÙˆØ¬`; } 
        else { alertBox.style.display = 'none'; }
    }

    window.setupDateDropdown = function() {
        const s = document.getElementById('checkInDate'); const h = new Date().getHours();
        const t = new Date(); const y = new Date(t); y.setDate(y.getDate()-1);
        const fDis = d => {
            const datePart = d.toLocaleDateString('en-GB');
            const dayName = d.toLocaleDateString('ar-EG', { weekday: 'long' });
            return `${datePart} ${dayName}`;
        };
        const valT = t.toISOString(), valY = y.toISOString();
        let html = '';
        if (h < 6) { html += `<option value="${valY}" selected>ğŸ“… Ù‚Ø¯ÙŠÙ… ${fDis(y)}</option><option value="${valT}">â˜€ï¸ Ø¬Ø¯ÙŠØ¯ ${fDis(t)}</option>`; } 
        else { html += `<option value="${valT}" selected>â˜€ï¸ Ø¬Ø¯ÙŠØ¯ ${fDis(t)}</option>`; }
        s.innerHTML = html;
    }

    window.toggleRentType = function() {
        const t = document.getElementById('rentType').value;
        if(t==='Ø´Ù‡Ø±ÙŠ') { document.getElementById('dailyRateDiv').style.display='none'; document.getElementById('nightsCount').value=30; }
        else { document.getElementById('dailyRateDiv').style.display='block'; document.getElementById('nightsCount').value=''; }
        window.calculateCheckout();
    }
    window.calculateDailyTotal = function() {
        const r = parseFloat(document.getElementById('dailyRate').value)||0;
        // ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù„ÙŠØ§Ù„ÙŠ Ø¥Ù„Ù‰ Ø±Ù‚Ù… ØµØ­ÙŠØ­ (Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙƒØ³ÙˆØ±)
        const n = parseInt(document.getElementById('nightsCount').value)||0; 
        if(document.getElementById('rentType').value==='ÙŠÙˆÙ…ÙŠ') document.getElementById('totalRentAmount').value = r*n;
        calculateRemaining(); calculateCheckout();
    }
    window.calculateRemaining = function() {
        document.getElementById('remainingAmount').value = (parseFloat(document.getElementById('totalRentAmount').value)||0) - (parseFloat(document.getElementById('paidAmount').value)||0);
    }
    window.calculateCheckout = function() {
        const dateVal = document.getElementById('checkInDate').value;
        const nights = document.getElementById('nightsCount').value;
        if (!dateVal || !nights) { document.getElementById('checkOutDate').value = ''; return; }
        const d = new Date(dateVal);
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Math.floor Ù„Ø¶Ù…Ø§Ù† Ø£Ù† Ø§Ù„Ù„ÙŠØ§Ù„ÙŠ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­ Ù…ÙˆØ¬Ø¨ (ÙŠØªÙ… ØªØ¬Ø§Ù‡Ù„ 0.6 Ù„ÙŠÙ„Ø© Ù…Ø«Ù„Ø§Ù‹)
        const wholeNights = Math.floor(parseFloat(nights)); 
        d.setDate(d.getDate() + wholeNights);
        document.getElementById('checkOutDate').value = d.toLocaleDateString('en-GB');
    }
    
    // ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ù„Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø¸Ù‡ÙˆØ±
    window.toggleImageUpload = function() {
        const paymentMethod = document.getElementById('paymentMethod').value;
        const status = document.getElementById('bankStatusSelect').value;
        const proofSection = document.getElementById('bankProofSection');

        if (paymentMethod === 'ØªØ­ÙˆÙŠÙ„' && status === 'confirmed') {
            proofSection.style.display = 'block';
        } else {
            proofSection.style.display = 'none';
        }
    }
    
    window.togglePaymentSections = function() {
        const m = document.getElementById('paymentMethod').value;
        document.getElementById('mixedSection').style.display = m==='Ù…Ø®ØªÙ„Ø·'?'grid':'none';
        document.getElementById('bankSection').style.display = m==='ØªØ­ÙˆÙŠÙ„'?'block':'none';
        if(m!=='Ù…Ø®ØªÙ„Ø·') document.getElementById('paidAmount').readOnly = false;
        
        window.toggleImageUpload(); 
    }
    window.calculateMixedTotal = function() {
        const tot = (parseFloat(document.getElementById('mixedCash').value)||0) + (parseFloat(document.getElementById('mixedNet').value)||0) + (parseFloat(document.getElementById('mixedBank').value)||0);
        document.getElementById('paidAmount').value = tot;
        document.getElementById('paidAmount').readOnly = true;
        calculateRemaining();
    }
    window.updateButtonState = function() {
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… parseInt Ù„Ø­Ø°Ù Ø§Ù„ÙƒØ³ÙˆØ± Ù…Ù† Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ© Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙŠÙ…ØªÙ‡
        const r = parseInt(document.getElementById('roomNumber').value); 
        const b = document.getElementById('saveBtn');
        if(isNaN(r)) { // ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© Ù„ÙŠØ³Øª 'NaN' (Ø£ÙŠ Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ù‚Ù… ØµØ­ÙŠØ­)
            b.innerText='Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± Ø­Ø§Ù„Ø© ğŸ“'; b.style.background='var(--booking-blue)'; 
        }
        else { b.innerText='Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„ ğŸš€'; b.style.background='var(--success)'; }
    }

    window.requestHandover = function() { if(confirm('Ø·Ù„Ø¨ ØªÙˆØ±ÙŠØ¯ØŸ')) { const u={}; transactions.forEach(t=>{if(t.isHandedOver===false) u[`transactions/${t.firebaseKey}/isHandedOver`]='pending'}); update(ref(db),u); showToast('ØªÙ… Ø§Ù„Ø·Ù„Ø¨'); } }
    window.approveHandover = function() { if(prompt('ÙƒÙˆØ¯ Ø§Ù„Ù…Ø¯ÙŠØ±:')==='fahd5') { const u={}; transactions.forEach(t=>{if(t.isHandedOver==='pending') u[`transactions/${t.firebaseKey}/isHandedOver`]=true}); update(ref(db),u); showToast('ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯'); } }
    window.checkoutRoom = function(k) { if(confirm('Ø®Ø±ÙˆØ¬ØŸ')) update(ref(db,`transactions/${k}`),{status:'completed'}); }
    window.deleteHandedOver = function() { if(confirm('Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ±Ø¯ØŸ')) transactions.forEach(t=>{if(t.isHandedOver===true) remove(ref(db,`transactions/${t.firebaseKey}`))}); }
    window.deleteExpired = function() { if(confirm('Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØŸ')) transactions.forEach(t=>{if(t.status==='completed') remove(ref(db,`transactions/${t.firebaseKey}`))}); }
    window.toggleBankStatus = function(k, s) { if(s.includes('Ù„Ù… ÙŠØ¤ÙƒØ¯') && confirm('ØªØ£ÙƒÙŠØ¯ØŸ')) update(ref(db, `transactions/${k}`), { paymentMethod: s.replace('Ù„Ù… ÙŠØ¤ÙƒØ¯ â³', 'ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… âœ…') }); }
    window.showToast = function(m) { const t=document.getElementById('toastMsg'); document.getElementById('toastText').innerText=m; document.getElementById('toast-container').style.opacity=1; setTimeout(()=>document.getElementById('toast-container').style.opacity=0,2000); }
    window.exportToExcel = function() { if(!transactions.length)return; const d=transactions.map(t=>({"Ø§Ù„ØºØ±ÙØ©":t.roomNumber,"Ø§Ù„Ù…Ø¨Ù„Øº":t.amount,"Ø§Ù„Ø¯ÙØ¹":t.paymentMethod,"Ø¯Ø®ÙˆÙ„":t.checkIn})); const ws=XLSX.utils.json_to_sheet(d); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Report"); XLSX.writeFile(wb,"Report.xlsx"); }

    // ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù‡Ù†Ø§
    document.addEventListener('DOMContentLoaded', () => {
        const cameraInput = document.getElementById('cameraInput');
        const fileInput = document.getElementById('fileInput');
        const bankProofImage = document.getElementById('bankProofImage');
        const fileNameDisplay = document.getElementById('fileNameDisplay');

        // Helper function to handle file selection and update UI
        const handleFileSelection = (sourceInput) => {
            const file = sourceInput.files[0];
            if (file) {
                // 1. Clear the previous input content and copy the file
                bankProofImage.files = sourceInput.files;
                // 2. Update the display name
                fileNameDisplay.innerText = `ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù: ${file.name}`;
                fileNameDisplay.style.color = 'var(--success)';
            }
        };

        // Listeners for the two visual inputs
        if (cameraInput) {
            cameraInput.addEventListener('change', () => handleFileSelection(cameraInput));
        }
        if (fileInput) {
            fileInput.addEventListener('change', () => handleFileSelection(fileInput));
        }

        // We run toggleImageUpload here to set the initial state
        window.toggleImageUpload(); 
    });


    // ØªÙ… Ø¥Ø­Ù„Ø§Ù„ Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
    document.getElementById('checkinForm').addEventListener('submit', function(e){
        e.preventDefault();
        window.saveVacanciesToCloud();
        const roomNum = document.getElementById('roomNumber').value;
        
        const v1=document.getElementById('vac1Input').value, v2=document.getElementById('vac2Input').value, v3=document.getElementById('vac3Input').value;
        const b1=document.getElementById('book1Input').value, b2=document.getElementById('book2Input').value, b3=document.getElementById('book3Input').value;
        
        const generateRec = (v,b,name) => {
            const vac=parseInt(v)||0, book=parseInt(b)||0;
            if(book>=vac && vac>0) return `â›” Ù‚ÙÙ„ Ø¨ÙˆÙƒÙŠÙ†Ø¬ (${name}) ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯Ùƒ ÙØ§Ø¦Ø¶ ${book-vac}`;
            if(vac>=5 && book<vac) return `âœ… Ø§ÙØªØ­ Ø¹Ø¯Ø¯ ${vac-book} (${name}) Ø¹Ù„Ù‰ Ø¨ÙˆÙƒÙŠÙ†Ø¬`;
            return null;
        };
        const recs = [generateRec(v3,b3,'Ù…ÙØ±Ø¯'), generateRec(v1,b1,'ØºØ±ÙØ© ÙˆØµØ§Ù„Ø©'), generateRec(v2,b2,'ØºØ±ÙØªÙŠÙ†')].filter(r=>r);
        const recText = recs.length ? `----------------------------\nÙ…Ù†Ø¸ÙˆÙ…Ù‡ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ù…Ø®ØªÙ„Ø· ØªÙ†ØµØ­ Ø¨\n${recs.join('\n')}` : '';

        if (!roomNum) {
            const net1=(parseInt(v1)||0)-(parseInt(b1)||0), net2=(parseInt(v2)||0)-(parseInt(b2)||0), net3=(parseInt(v3)||0)-(parseInt(b3)||0);
            const nowStr = new Date().toLocaleTimeString('ar-EG', {hour: 'numeric', minute:'numeric', hour12: true}).replace(/ /g, ''); 
            const nextStr = new Date(Date.now() + 4*60*60*1000).toLocaleTimeString('ar-EG', {hour: 'numeric', minute:'numeric', hour12: true}).replace(/ /g, '');
            
            const txt = `-----------------------------\nØªÙ‚Ø±ÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø´ØºØ§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ\nØ§Ù„Ø³Ø§Ø¹Ù‡ ${nowStr}\nØ§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ§Ù„ÙŠ ${nextStr}\n----------------------------\nğŸ”¢ Ø§Ù„Ø´Ø§ØºØ±: ${net3} Ù…ÙØ±Ø¯ | ${net1} ØºØ±Ù ÙˆØµØ§Ù„Ù‡ | ${net2} ØºØ±ÙØªÙŠÙ†\nÙ…Ø­Ø¬ÙˆØ² Ø¨ÙˆÙƒÙŠÙ†Ø¬ : ${b3} Ù…ÙØ±Ø¯ Ùˆ ${b1} ØºØ±ÙÙ‡ ÙˆØµØ§Ù„Ù‡ Ùˆ ${b2} ØºØ±ÙØªÙŠÙ†\n${recText}\n----------------------------\nğŸ•’: ${new Date().toLocaleString('ar-EG')}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(txt.trim())}`, '_blank');
            return;
        }

        const data = {
            id: Date.now(),
            roomNumber: roomNum,
            roomType: document.getElementById('roomTypeInput').value,
            roomTypeName: document.getElementById('roomTypeInput').options[document.getElementById('roomTypeInput').selectedIndex].text,
            bookingSource: document.getElementById('bookingSource').value,
            amount: document.getElementById('paidAmount').value,
            paymentMethod: document.getElementById('paymentMethod').value,
            rentType: document.getElementById('rentType').value,
            nights: document.getElementById('nightsCount').value,
            checkIn: new Date(document.getElementById('checkInDate').value).toISOString(),
            checkOut: document.getElementById('checkOutDate').value,
            totalContract: document.getElementById('totalRentAmount').value,
            debt: document.getElementById('remainingAmount').value,
            status: 'active', isHandedOver: false, actionTime: new Date().toISOString()
        };

        if(data.paymentMethod === 'Ù…Ø®ØªÙ„Ø·') {
            data.mixDetails = { cash: document.getElementById('mixedCash').value, net: document.getElementById('mixedNet').value, bank: document.getElementById('mixedBank').value };
            data.paymentMethod = `Ù…Ø®ØªÙ„Ø· (${data.mixDetails.cash} ÙƒØ§Ø´ + ${data.mixDetails.net} Ø´Ø¨ÙƒØ© + ${data.mixDetails.bank} ØªØ­ÙˆÙŠÙ„)`;
        }
        
        const isBankTransfer = data.paymentMethod.includes('ØªØ­ÙˆÙŠÙ„');
        let bankStatus = '';
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ù‚Ù„ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù‡Ù†Ø§
        let bankProofFile = document.getElementById('bankProofImage').files[0] || null; 

        if (isBankTransfer) {
            bankStatus = document.getElementById('bankStatusSelect').value;
            data.paymentMethod += (bankStatus === 'confirmed') ? ' (ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… âœ…)' : ' (Ù„Ù… ÙŠØ¤ÙƒØ¯ â³)';
            
            if (bankStatus === 'confirmed') {
                if (!bankProofFile) {
                    window.showToast('â›” ÙŠØ¬Ø¨ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¥Ø«Ø¨Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù….');
                    return; 
                }
            }
        }
        
        // ÙˆØ¸ÙŠÙØ© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø³ÙˆØ§Ø¡ Ù…Ø¹ Ù…Ù„Ù Ø£Ùˆ Ø¨Ø¯ÙˆÙ†Ù‡)
        const finalizeSubmission = (finalData) => {
            push(transactionsRef, finalData);

            let moneyDetails = `*ğŸ’° Ø§Ù„Ù…Ø¯ÙÙˆØ¹:* ${finalData.amount} Ø±ÙŠØ§Ù„`;
            if (finalData.totalContract > finalData.amount) moneyDetails += `\n*ğŸ“‰ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:* ${finalData.totalContract}\n*âš ï¸ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:* ${finalData.debt}`;
            
            const dateStr = new Date(finalData.checkIn).toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'numeric', day: 'numeric' });
            const net1=(parseInt(v1)||0)-(parseInt(b1)||0), net2=(parseInt(v2)||0)-(parseInt(b2)||0), net3=(parseInt(v3)||0)-(parseInt(b3)||0);

            const txt = `ØªÙ‚Ø±ÙŠØ± Ø¥ÙŠØ¬Ø§Ø± ØºØ±ÙØ© ${finalData.roomNumber} - ${finalData.roomTypeName}\n----------------------------\nÙ†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯: ${finalData.rentType} (${finalData.bookingSource})\n${moneyDetails}\nğŸ—“ï¸ Ø§Ù„Ø¯Ø®ÙˆÙ„: ${dateStr}\nğŸŒ™ Ø§Ù„Ù…Ø¯Ø©: ${finalData.nights} Ù„ÙŠØ§Ù„ÙŠ\nğŸ“¤ Ø§Ù„Ø®Ø±ÙˆØ¬: ${finalData.checkOut}\nğŸ’³ Ø§Ù„Ø¯ÙØ¹: ${finalData.paymentMethod}\n${finalData.proofUrl ? `ğŸ–¼ï¸ Ø§Ù„Ø¥ÙŠØµØ§Ù„: ${finalData.proofUrl}\n` : ''}ğŸ”¢ Ø§Ù„Ø´Ø§ØºØ±: ${net3} Ù…ÙØ±Ø¯ | ${net1} ØºØ±Ù ÙˆØµØ§Ù„Ù‡ | ${net2} ØºØ±ÙØªÙŠÙ†\nÙ…Ø­Ø¬ÙˆØ² Ø¨ÙˆÙƒÙŠÙ†Ø¬ : ${b3} Ù…ÙØ±Ø¯ Ùˆ ${b1} ØºØ±ÙÙ‡ ÙˆØµØ§Ù„Ù‡ Ùˆ ${b2} ØºØ±ÙØªÙŠÙ†\n${recText}\n----------------------------\nğŸ•’: ${new Date(finalData.actionTime).toLocaleString('ar-EG')}`;
            
            window.open(`https://wa.me/?text=${encodeURIComponent(txt.trim())}`, '_blank');
            
            this.reset(); setupDateDropdown(); updateButtonState();
            document.getElementById('bankProofSection').style.display = 'none'; 
            document.getElementById('loader').style.display = 'none'; 
            window.toggleImageUpload(); 
            
            // Ù…Ø³Ø­ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø¨Ù‚Ø§Ø¦Ù‡Ø§ ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
            document.getElementById('bankProofImage').value = null; 
        }

        // -----------------------------------------------------
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±ÙØ¹ Ø¥Ù„Ù‰ Firebase Storage
        // -----------------------------------------------------
        if (bankProofFile && isBankTransfer && bankStatus === 'confirmed') {
            document.getElementById('loaderText').innerText = 'Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ø¥ÙŠØµØ§Ù„...';
            document.getElementById('loader').style.display = 'flex';
            
            const fileExtension = bankProofFile.name.split('.').pop();
            const path = `bank_proofs/${data.roomNumber}_${data.id}.${fileExtension}`;
            const imageRef = storageRef(storage, path);
            
            uploadBytes(imageRef, bankProofFile).then((snapshot) => {
                getDownloadURL(snapshot.ref).then((downloadURL) => {
                    data.proofUrl = downloadURL; 
                    window.showToast('âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø¥ÙŠØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­.');
                    finalizeSubmission(data);
                });
            }).catch((error) => {
                document.getElementById('loader').style.display = 'none';
                console.error("Firebase Storage Upload Error:", error);
                window.showToast('âŒ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ø¥ÙŠØµØ§Ù„. Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹.');
            });
            
        } else {
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…Ù„Ù Ù„Ù„Ø±ÙØ¹ (Ù†Ù‚Ø¯ÙŠØŒ Ø´Ø¨ÙƒØ©ØŒ Ø£Ùˆ ØªØ­ÙˆÙŠÙ„ ØºÙŠØ± Ù…Ø¤ÙƒØ¯)
            finalizeSubmission(data);
        }
    });

    

  // ----------------- Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª (Ù…Ø¹Ø¯Ù„ Ù„Ù…Ù†Ø¹ Ø§Ù„Ù†Ù‚Ø·Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹) -----------------

    // 1. ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø§Ù„ÙŠØ© (ØªÙ‚Ø¨Ù„ Ø§Ù„ÙƒØ³ÙˆØ±)
    const moneyFieldsIds = [
        "dailyRate",
        "totalRentAmount",
        "paidAmount",
        "remainingAmount",
        "mixedCash",
        "mixedNet",
        "mixedBank"
    ];

    // 2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙŠ Ø§Ù„ØµÙØ­Ø©
    document.querySelectorAll('input[type="number"]').forEach(inp => {
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù‡Ù„ Ø§Ù„Ø­Ù‚Ù„ Ù…Ø§Ù„ÙŠ Ø£Ù… Ù„Ø§
        if (moneyFieldsIds.includes(inp.id)) {
            // --- Ø£: Ø­Ù‚Ù„ Ù…Ø§Ù„ÙŠ (ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„ÙƒØ³ÙˆØ±) ---
            inp.addEventListener("input", () => {
                // Ø§Ù„Ø³Ù…Ø§Ø­ ÙÙ‚Ø· Ø¨Ø£Ø±Ù‚Ø§Ù… ÙˆÙ†Ù‚Ø·Ø© ÙˆØ§Ø­Ø¯Ø©ØŒ ÙˆÙ…Ù†Ø²Ù„ØªÙŠÙ† Ø¹Ø´Ø±ÙŠØªÙŠÙ†
                if (inp.value.includes('.')) {
                   const parts = inp.value.split('.');
                   if (parts[1].length > 2) {
                       inp.value = parseFloat(inp.value).toFixed(2);
                   }
                }
            });
        } else {
            // --- Ø¨: Ø­Ù‚Ù„ ØºÙŠØ± Ù…Ø§Ù„ÙŠ (Ù…Ù…Ù†ÙˆØ¹ Ø§Ù„ÙƒØ³ÙˆØ± ÙˆØ§Ù„Ù†Ù‚Ø·Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹) ---
            
            // 1. Ù…Ù†Ø¹ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù…Ù† Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ (Ù†Ù‚Ø·Ø©ØŒ ÙØ§ØµÙ„Ø©ØŒ Ø­Ø±ÙˆÙ)
            inp.addEventListener("keydown", (e) => {
                // Ù‡Ù†Ø§ Ù†Ù…Ù†Ø¹ Ø²Ø± Ø§Ù„Ù†Ù‚Ø·Ø© (.) ÙˆØ§Ù„ÙØ§ØµÙ„Ø© (,) Ùˆ Ø­Ø±Ù e Ùˆ E ÙˆØ§Ù„Ø±Ù…ÙˆØ² + -
                // Ø¨Ù…Ø¬Ø±Ø¯ Ø§Ù„Ø¶ØºØ·ØŒ ÙŠØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¯Ø« ÙˆÙ„Ù† ÙŠØ¸Ù‡Ø± Ø´ÙŠØ¡ ÙÙŠ Ø§Ù„Ø­Ù‚Ù„
                if (["." , "," , "e", "E", "+", "-"].includes(e.key)) {
                    e.preventDefault();
                }
            });

            // 2. ØªÙ†Ø¸ÙŠÙ Ø¹Ù†Ø¯ Ø§Ù„Ù„ØµÙ‚ (Paste)
            inp.addEventListener("input", (e) => {
               // Ø¥Ø°Ø§ Ø­Ø§ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§Ù„ØªÙØ§Ù ÙˆÙ„ØµÙ‚ Ø±Ù‚Ù… Ø¨ÙƒØ³ÙˆØ±ØŒ Ù†Ù‚ÙˆÙ… Ø¨Ù…Ø³Ø­ Ø§Ù„ÙƒØ³ÙˆØ± ÙÙˆØ±Ø§Ù‹
               // Ø£Ùˆ Ù†Ø­Ø°Ù Ø£ÙŠ Ø´ÙŠØ¡ Ù„ÙŠØ³ Ø±Ù‚Ù…Ø§Ù‹
               inp.value = inp.value.replace(/[^\d]/g, "");
            });
        }
    });

// ----------------- Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø¹Ø¯Ù„ -----------------

    setupDateDropdown();
    toggleRentType();
    togglePaymentSections();
    updateButtonState();
</script>
</body>
    </html>
